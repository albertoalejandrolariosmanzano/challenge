name: CI-CD
on:
  push:
    branches: [ api ]
  pull_request:
    branches: [ api ]

jobs:
  # install:
  #   runs-on: ubuntu-latest
  #   container:
  #     image: smraalm/node:1.0
  #   steps:
  #     - uses: actions/checkout@v2
  #     - name: Copy env file
  #       run: cp .env.example .env
  #     - name: Install dependencies
  #       run: |
  #         npm install --save-dev sequelize-cli
  #         yarn install --production
  #       # npx sequelize-cli db:migrate

  build:
    # needs: install
    runs-on: ubuntu-latest
    container:
      image: smraalm/kubetools:1.1
    steps:
      - uses: actions/checkout@v2
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      - name: Building backend API
        env:
          AWS_CONTAINER_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          APP_NAME: api-staging
        run: |
          docker build -t $AWS_CONTAINER_REGISTRY/$APP_NAME:${{ github.sha }} .
      - name: Push Image to ECR
        if: success()
        env:
          AWS_CONTAINER_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          APP_NAME: api-staging
        run: |
          docker push $AWS_CONTAINER_REGISTRY/$APP_NAME:${{ github.sha }}
      - name: Logout of Amazon ECR
        if: always()
        run: docker logout ${{ steps.login-ecr.outputs.registry }}

  deploy:
    needs: build
    runs-on: ubuntu-latest
    container:
      image: smraalm/kubetools:1.1
    steps:
      - uses: actions/checkout@v2
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      - name: Deploy backend API
        env:
          AWS_CONTAINER_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          APP_NAME: api-staging
          PATHS: api
          IMG_PATH: $PATHS.image
          RESOURCES: resources
          HOST: $PATHS.ingress
        run: |
          aws eks update-kubeconfig --name ${{ secrets.AWS_CLUSTER_ID }}
          helm repo add api $HELM_REPO
          helm repo update
          helm install api api/api \
            --set $IMG_PATH.repository=$AWS_CONTAINER_REGISTRY/$APP_NAME \
            --set $IMG_PATH.tag=${{ github.sha }} \
            -n staging
        # helm upgrade api api/api \
        #   --set replicaCount=$REPLICA \
        #   --set $IMG_PATH.repository=$AWS_CONTAINER_REGISTRY/$APP_NAME-2 \
        #   --set $IMG_PATH.tag=$CI_COMMIT_SHA \
        #   --set $HOST.hosts.host=$SITE_URI \
        #   # --set $PATHS.$RESOURCES.requests.cpu=$CPU_R \
        #   # --set $PATHS.$RESOURCES.requests.memory=$RAM_R \
        #   # --set $PATHS.$RESOURCES.limits.cpu=$CPU_L \
        #   # --set $PATHS.$RESOURCES.limits.memory=$RAM_L \
        #   -n staging